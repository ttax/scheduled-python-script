# 工作流名称
name: 定时运行基金钉钉通知脚本

# 触发规则：每小时定时触发 + 手动触发
on:
  # 定时触发（UTC时间，每小时的第0分钟运行，对应北京时间每小时8分0秒）
  schedule:
    - cron: '0 * * * *'
  # 手动触发（测试用）
  workflow_dispatch:

# 任务配置
jobs:
  run-fund-script:
    runs-on: ubuntu-latest
    # 配置环境变量（存放钉钉机器人Token，避免硬编码）
    env:
      DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}

    steps:
      # 步骤1：拉取仓库代码
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      # 步骤2：设置Python环境
      - name: 设置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 步骤3：安装依赖（你的脚本需要requests库）
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests  # 明确安装requests（你的脚本依赖它）

      # 步骤4：修改脚本中的Webhook（替换为环境变量）
      - name: 替换脚本中的钉钉Webhook
        run: |
          # 将脚本中硬编码的DINGTALK_WEBHOOK替换为环境变量
          sed -i "s|DINGTALK_WEBHOOK = \".*\"|DINGTALK_WEBHOOK = \"$DINGTALK_WEBHOOK\"|" script.py

      # 步骤5：执行脚本
      - name: 运行基金通知脚本
        run: python script.py
